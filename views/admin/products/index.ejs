<!DOCTYPE html>
<html lang="vi">

<head>
  <title>Quản lý sản phẩm</title>
  <%- include('../../partials/admin/Head') %>
  <style>
    .modal-body img {
      max-width: 100%;
      height: auto;
      display: block;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .variant-image-thumbnail {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
      margin-right: 10px;
      margin-bottom: 10px;
      border: 1px solid #eee;
      cursor: pointer;
    }

    .product-images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .product-images-grid img {
      width: 100%;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #eee;
    }

    .table img {
      transition: transform 0.2s;
    }

    .table img:hover {
      transform: scale(1.5);
      z-index: 10;
      position: relative;
    }
  </style>
</head>

<body>
  <div class="container-fluid position-relative bg-white d-flex p-0">

    <%- include('../../partials/admin/Reload') %>
    <%- include('../../partials/admin/Sidebar') %>

    <div class="content">
      <%- include('../../partials/admin/Header') %>

      <div class="container-fluid pt-4 px-4">
        <div class="row g-4">
          <div class="col-12">
            <div class="bg-light rounded h-100 p-4">
              <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                <h5 class="mb-0 text-primary">Danh sách sản phẩm</h5>
                <a href="/admin/products/add" class="btn btn-primary">
                  <i class="fa fa-plus me-2"></i>Thêm sản phẩm mới
                </a>
              </div>

              <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3 bg-white p-3 rounded shadow-sm border">

                <div class="d-flex align-items-center">
                  <i class="fa fa-filter text-muted me-2"></i>
                  <select class="form-select form-select-sm" id="categoryFilter" style="min-width: 200px;">
                    <option value="">-- Tất cả danh mục --</option>
                    <% childrenCategories.forEach(cat => { %>
                    <option value="<%= cat._id %>" <%= currentCategory == cat._id ? 'selected' : '' %>>
                      <%= cat.name %>
                    </option>
                    <% }) %>
                  </select>
                </div>

                <div class="d-flex align-items-center">
                  <label class="me-2 text-muted small">Hiển thị:</label>
                  <select class="form-select form-select-sm" style="width: 70px;" id="limitSelect">
                    <option value="5" <%= pagination.limit === 5 ? 'selected' : '' %>>5</option>
                    <option value="10" <%= pagination.limit === 10 ? 'selected' : '' %>>10</option>
                    <option value="20" <%= pagination.limit === 20 ? 'selected' : '' %>>20</option>
                    <option value="50" <%= pagination.limit === 50 ? 'selected' : '' %>>50</option>
                  </select>
                </div>
              </div>

              <% if (!products || products.length === 0) { %>
              <div class="alert alert-warning text-center p-5">
                <i class="fa fa-box-open fa-3x mb-3 text-warning"></i>
                <p class="mb-0">Không tìm thấy sản phẩm nào.</p>
                <% if (currentCategory) { %>
                <a href="/admin/products" class="btn btn-sm btn-outline-dark mt-2">Xóa bộ lọc</a>
                <% } %>
              </div>
              <% } else { %>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col" width="5%">#</th>
                      <th scope="col" width="10%">Ảnh</th>
                      <th scope="col" width="25%">Tên sản phẩm</th>
                      <th scope="col" width="15%">Danh mục/Loại</th>
                      <th scope="col" width="15%">Giá</th>
                      <th scope="col" width="10%">Kho</th>
                      <th scope="col" width="10%">Trạng thái</th>
                      <th scope="col" width="10%">Hành động</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% products.forEach((product, index) => { %>
                    <tr>
                      <td>
                        <%= (pagination.page - 1) * pagination.limit + index + 1 %>
                      </td>
                      <td>
                        <img src="<%= product.thumbnail || '/images/null.png' %>" alt="<%= product.name %>" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #eee;">
                      </td>
                      <td>
                        <div class="fw-bold text-dark"><%= product.name %></div>
                        <small class="text-muted d-block text-truncate" style="max-width: 200px;">
                          Slug: <%= product.slug %>
                        </small>
                      </td>
                      <td>
                        <% if (product.category_id) { %>
                        <div class="badge bg-info mb-1"><%= product.category_id.name %></div>
                        <% } else { %>
                        <div class="badge bg-secondary mb-1">Chưa phân loại</div>
                        <% } %>
                        <br>
                        <% if (product.has_variants) { %>
                        <small class="text-warning"><i class="fa fa-tags"></i> <%= product.variants.length %> Biến thể</small>
                        <% } else { %>
                        <small class="text-muted"><i class="fa fa-cube"></i> Đơn giản</small>
                        <% } %>
                      </td>
                      <td>
                        <% if (product.has_variants) { %>
                        <% 
                                                            let minPrice = Infinity;
                                                            let maxPrice = 0;
                                                            let hasSize = false;
                                                            product.variants.forEach(v => {
                                                                if(v.sizes && v.sizes.length > 0) {
                                                                    hasSize = true;
                                                                    v.sizes.forEach(s => {
                                                                        if (s.price < minPrice) minPrice = s.price;
                                                                        if (s.price > maxPrice) maxPrice = s.price;
                                                                    });
                                                                }
                                                            });
                                                            if (!hasSize) minPrice = 0;
                                                            %>
                        <div class="fw-bold text-primary">
                          <%= minPrice.toLocaleString('vi-VN') %>₫
                        </div>
                        <% if (minPrice !== maxPrice) { %>
                        <small class="text-muted">~ <%= maxPrice.toLocaleString('vi-VN') %>₫</small>
                        <% } %>
                        <% } else { %>
                        <div class="fw-bold text-primary">
                          <%= (product.price || 0).toLocaleString('vi-VN') %>₫
                        </div>
                        <% } %>
                      </td>
                      <td>
                        <% if (product.has_variants) { %>
                        <% 
                                                            let totalStock = 0;
                                                            product.variants.forEach(v => {
                                                                if(v.sizes) {
                                                                    v.sizes.forEach(s => totalStock += s.stock);
                                                                }
                                                            });
                                                            %>
                        <span class="badge rounded-pill <%= totalStock > 0 ? 'bg-success' : 'bg-danger' %>">
                          <%= totalStock %>
                        </span>
                        <% } else { %>
                        <span class="badge rounded-pill <%= product.stock > 0 ? 'bg-success' : 'bg-danger' %>">
                          <%= product.stock || 0 %>
                        </span>
                        <% } %>
                      </td>
                      <td>
                        <% if (product.is_active) { %>
                        <span class="badge border border-success text-success bg-white">Hoạt động</span>
                        <% } else { %>
                        <span class="badge border border-danger text-danger bg-white">Đã ẩn</span>
                        <% } %>
                        <br>
                        <small class="text-muted" style="font-size: 10px;">
                          <%= moment(product.createdAt).format('DD/MM/YY') %>
                        </small>
                      </td>
                      <td>
                        <div class="btn-group">
                          <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#productDetailModal" data-id="<%= product._id %>" title="Xem chi tiết">
                            <i class="fa fa-eye"></i>
                          </button>
                          <a href="/admin/products/edit/<%= product._id %>" class="btn btn-sm btn-outline-warning" title="Sửa">
                            <i class="fa fa-edit"></i>
                          </a>
                          <% if (product.is_active) { %>
                          <button class="btn btn-sm btn-outline-danger btn-delete" data-id="<%= product._id %>" title="Xóa tạm thời">
                            <i class="fa fa-trash"></i>
                          </button>
                          <% } else { %>
                          <button class="btn btn-sm btn-outline-success btn-restore" data-id="<%= product._id %>" title="Khôi phục">
                            <i class="fa fa-undo"></i>
                          </button>
                          <button class="btn btn-sm btn-dark btn-force-delete" data-id="<%= product._id %>" title="Xóa vĩnh viễn">
                            <i class="fa fa-times"></i>
                          </button>
                          <% } %>
                        </div>
                      </td>
                    </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>

              <% if (pagination.totalPages > 1) { %>
              <div class="d-flex justify-content-between align-items-center mt-3">
                <small class="text-muted">
                  Hiển thị <%= (pagination.page - 1) * pagination.limit + 1 %> -
                  <%= Math.min(pagination.page * pagination.limit, pagination.totalProducts) %>
                  trên <%= pagination.totalProducts %> sản phẩm
                </small>
                <nav aria-label="Page navigation">
                  <ul class="pagination pagination-sm mb-0">
                    <% const buildUrl = (p) => `?page=${p}&limit=${pagination.limit}${currentCategory ? '&category=' + currentCategory : ''}`; %>

                    <li class="page-item <%= pagination.page === 1 ? 'disabled' : '' %>">
                      <a class="page-link" href="<%= buildUrl(pagination.page - 1) %>"><i class="fa fa-chevron-left"></i></a>
                    </li>

                    <% for(let i = 1; i <= pagination.totalPages; i++) { %>

                    <% if (i === 1 || i === pagination.totalPages || (i >= pagination.page - 1 && i <= pagination.page + 1)) { %>
                    <li class="page-item <%= pagination.page === i ? 'active' : '' %>">
                      <a class="page-link" href="<%= buildUrl(i) %>"><%= i %></a>
                    </li>
                    <% } else if (i === pagination.page - 2 || i === pagination.page + 2) { %>
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    <% } %>
                    <% } %>

                    <li class="page-item <%= pagination.page === pagination.totalPages ? 'disabled' : '' %>">
                      <a class="page-link" href="<%= buildUrl(pagination.page + 1) %>"><i class="fa fa-chevron-right"></i></a>
                    </li>
                  </ul>
                </nav>
              </div>
              <% } %>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <%- include('../../partials/admin/Footer') %>
    </div>

    <div class="modal fade" id="productDetailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header bg-light">
            <h5 class="modal-title"><i class="fa fa-info-circle text-primary me-2"></i>Chi tiết sản phẩm</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="modalProductContent">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          </div>
        </div>
      </div>
    </div>

    <%- include('../../partials/admin/Script') %>

    <script>
      $(document).ready(function() {
        $('#limitSelect').on('change', function() {
          const url = new URL(window.location.href);
          url.searchParams.set('limit', this.value);
          url.searchParams.set('page', 1);
          window.location.href = url.toString();
        });

        $('#categoryFilter').on('change', function() {
          const url = new URL(window.location.href);
          if (this.value) {
            url.searchParams.set('category', this.value);
          } else {
            url.searchParams.delete('category');
          }
          url.searchParams.set('page', 1);
          window.location.href = url.toString();
        });

        $('#productDetailModal').on('show.bs.modal', function(event) {
          const button = $(event.relatedTarget);
          const productId = button.data('id');
          const $content = $('#modalProductContent');

          $content.html(`
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Đang tải dữ liệu...</p>
            </div>
        `);

          $.get(`/admin/products/view/${productId}`)
            .done(function(result) {
              if (!result.success) {
                $content.html(`<div class="alert alert-danger">Lỗi: ${result.message}</div>`);
                return;
              }

              const product = result.product;
              const formatMoney = (amount) => new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
              }).format(amount);

              let html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-body text-center">
                                    <img src="${product.thumbnail || '/images/null.png'}" class="img-fluid rounded" alt="Thumbnail">
                                </div>
                            </div>
                            ${product.images && product.images.length > 0 && !product.has_variants ? `
                                <h6 class="text-muted">Ảnh phụ:</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    ${product.images.map(img => `<img src="${img}" style="width:60px;height:60px;object-fit:cover;border:1px solid #ddd;border-radius:4px;">`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="col-md-8">
                            <h4 class="mb-3">${product.name}</h4>
                            <table class="table table-bordered table-sm">
                                <tbody>
                                    <tr><th width="30%">ID</th><td><code>${product._id}</code></td></tr>
                                    <tr><th>Slug</th><td>${product.slug}</td></tr>
                                    <tr><th>Danh mục</th><td>${product.category_id || '<span class="text-muted">Chưa phân loại</span>'}</td></tr>
                                    <tr><th>Loại</th><td>${product.has_variants ? 'Có biến thể' : 'Đơn giản'}</td></tr>
                                    <tr><th>Trạng thái</th><td>${product.is_active ? '<span class="text-success fw-bold">Hoạt động</span>' : '<span class="text-danger fw-bold">Đã ẩn</span>'}</td></tr>
                                    ${!product.has_variants ? `
                                        <tr><th>Giá</th><td class="text-primary fw-bold">${formatMoney(product.price)}</td></tr>
                                        <tr><th>Tồn kho</th><td>${product.stock}</td></tr>
                                    ` : ''}
                                </tbody>
                            </table>
                            <div class="bg-light p-3 rounded">
                                <strong>Mô tả:</strong>
                                <p class="mb-0 text-muted small">${product.description || 'Không có mô tả'}</p>
                            </div>
                        </div>
                    </div>
                `;

              if (product.has_variants && product.variants?.length > 0) {
                html += `<hr class="my-4"><h5 class="text-primary mb-3">Chi tiết Biến thể</h5>`;
                html += `<div class="accordion" id="accordionVariants">`;

                product.variants.forEach((variant, idx) => {
                  html += `
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button ${idx !== 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${idx}">
                                        <span class="d-inline-block rounded-circle border me-2" style="width:15px;height:15px;background:${variant.color_code || '#ccc'}"></span>
                                        Màu: <strong>${variant.color}</strong>
                                    </button>
                                </h2>
                                <div id="collapse${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" data-bs-parent="#accordionVariants">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                ${variant.images?.length > 0 
                                                    ? variant.images.map(img => `<img src="${img}" class="img-thumbnail me-1 mb-1" style="width:60px;height:60px;object-fit:cover;">`).join('')
                                                    : '<span class="text-muted small">Không có ảnh</span>'
                                                }
                                            </div>
                                            <div class="col-md-9">
                                                <table class="table table-sm table-striped">
                                                    <thead><tr><th>Size</th><th>Giá</th><th>Kho</th><th>SKU</th></tr></thead>
                                                    <tbody>
                                                        ${variant.sizes.map(s => `
                                                            <tr>
                                                                <td>${s.size}</td>
                                                                <td>${formatMoney(s.price)}</td>
                                                                <td>${s.stock}</td>
                                                                <td>${s.sku || '-'}</td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                });
                html += `</div>`;
              }

              $content.html(html);
            })
            .fail(function() {
              $content.html('<div class="alert alert-danger">Lỗi kết nối server</div>');
            });
        });

        const handleAction = (url, method, confirmMsg) => {
          if (!confirm(confirmMsg)) return;

          $.ajax({
            url: url,
            method: method,
            dataType: 'json',
            success: function(res) {
              if (res.success) {
                toastr.success(res.message || 'Thao tác thành công!');
                setTimeout(() => location.reload(), 800);
              } else {
                toastr.error(res.message || 'Thao tác thất bại!');
              }
            },
            error: () => toastr.error('Lỗi hệ thống!')
          });
        };

        $(document).on('click', '.btn-delete', function() {
          const id = $(this).data('id');
          handleAction(`/admin/products/delete/${id}`, 'POST', 'Chuyển sản phẩm vào thùng rác?');
        });

        $(document).on('click', '.btn-restore', function() {
          const id = $(this).data('id');
          handleAction(`/admin/products/restore/${id}`, 'POST', 'Khôi phục sản phẩm này?');
        });

        $(document).on('click', '.btn-force-delete', function() {
          const id = $(this).data('id');
          if (confirm('CẢNH BÁO: Xóa vĩnh viễn – Không thể khôi phục! Bạn có chắc chắn?')) {
            handleAction(`/admin/products/force-delete/${id}`, 'DELETE', '');
          }
        });
      });
    </script>
</body>

</html>