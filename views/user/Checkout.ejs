<!DOCTYPE html>
<html lang="vi">
  <head>
    <title>Thông tin đặt hàng</title>
    <%- include('../partials/user/Head') %>
    <style>
      .font-marcellus {
        font-family: "Marcellus", serif;
      }
      #loading-overlay {
        display: none;
      }
    </style>
  </head>

  <body class="bg-white">
    <%- include('../partials/user/SVGIcon') %> <%-
    include('../partials/user/Search') %> <%- include('../partials/user/Header')
    %>

    <div class="bg-gray-50 min-h-screen relative">
      <div
        id="loading-overlay"
        class="absolute inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center h-full w-full fixed top-0 left-0"
      >
        <div class="spinner-border text-gray-900" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <div
        id="empty-cart-view"
        class="container mx-auto px-4 py-16 text-center hidden"
      >
        <h1 class="text-3xl font-marcellus mt-6">
          Giỏ hàng của bạn đang trống.
        </h1>
        <p class="text-gray-600 mt-2">
          Bạn cần thêm sản phẩm vào giỏ trước khi thanh toán.
        </p>
        <a
          href="/"
          class="mt-6 inline-block bg-gray-900 text-white px-8 py-3 uppercase text-sm font-semibold rounded hover:bg-gray-800 transition-colors"
        >
          Quay lại cửa hàng
        </a>
      </div>

      <div id="checkout-view" class="container mx-auto px-4 pt-12 pb-24 hidden">
        <h1 class="text-3xl md:text-4xl font-marcellus text-center mb-10">
          Thanh Toán
        </h1>

        <form id="checkoutForm">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-x-12 gap-y-8">
            <div
              class="lg:col-span-2 bg-white p-8 rounded-lg shadow-md space-y-6"
            >
              <!-- Thông tin liên hệ -->
              <div>
                <h2 class="text-xl font-marcellus text-gray-900 mb-4">
                  Thông tin liên hệ
                </h2>
                <div>
                  <label
                    for="email"
                    class="block text-sm font-medium text-gray-700"
                    >Email</label
                  >
                  <div class="mt-1">
                    <input
                      type="email"
                      id="email"
                      name="email"
                      placeholder="email@example.com"
                      required
                      class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-500 focus:border-gray-500 sm:text-sm p-2 border"
                    />
                  </div>
                </div>
              </div>

              <!-- Địa chỉ giao hàng -->
              <div class="border-t pt-6">
                <h2 class="text-xl font-marcellus text-gray-900 mb-4">
                  Địa chỉ giao hàng
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label
                      for="full_name"
                      class="block text-sm font-medium text-gray-700"
                      >Họ và tên</label
                    >
                    <input
                      type="text"
                      id="full_name"
                      required
                      placeholder="Nguyễn Văn A"
                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-500 focus:border-gray-500 sm:text-sm p-2 border"
                    />
                  </div>
                  <div>
                    <label
                      for="phone"
                      class="block text-sm font-medium text-gray-700"
                      >Số điện thoại</label
                    >
                    <input
                      type="tel"
                      id="phone"
                      required
                      placeholder="0912345678"
                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-500 focus:border-gray-500 sm:text-sm p-2 border"
                    />
                  </div>
                  <div class="md:col-span-2">
                    <label
                      for="address"
                      class="block text-sm font-medium text-gray-700"
                      >Địa chỉ chi tiết</label
                    >
                    <input
                      type="text"
                      id="address"
                      required
                      placeholder="Số nhà, tên đường, phường/xã"
                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-500 focus:border-gray-500 sm:text-sm p-2 border"
                    />
                  </div>
                  <div class="md:col-span-2">
                    <label
                      for="note"
                      class="block text-sm font-medium text-gray-700"
                      >Ghi chú đơn hàng (Tùy chọn)</label
                    >
                    <textarea
                      id="note"
                      rows="2"
                      placeholder="Ví dụ: Giao hàng giờ hành chính"
                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-500 focus:border-gray-500 sm:text-sm p-2 border"
                    ></textarea>
                  </div>
                </div>
              </div>

              <!-- Phương thức thanh toán -->
              <div class="border-t pt-6">
                <h2 class="text-xl font-marcellus text-gray-900 mb-4">
                  Phương thức thanh toán
                </h2>
                <div class="space-y-4">
                  <label class="flex items-center">
                    <input
                      type="radio"
                      name="payment_method"
                      value="cod"
                      checked
                      class="h-4 w-4 text-gray-900"
                    />
                    <span class="ml-3 block text-sm font-medium text-gray-700"
                      >Thanh toán khi nhận hàng (COD)</span
                    >
                  </label>
                  <label class="flex items-center">
                    <input
                      type="radio"
                      name="payment_method"
                      value="bank_transfer"
                      class="h-4 w-4 text-gray-900"
                    />
                    <span class="ml-3 block text-sm font-medium text-gray-700"
                      >Chuyển khoản ngân hàng (Techcombank)</span
                    >
                  </label>
                </div>
              </div>
            </div>

            <div class="lg:col-span-1">
              <div class="bg-white p-6 rounded-lg shadow-md sticky top-6">
                <h2 class="text-lg font-medium text-gray-900 border-b pb-4">
                  Tóm tắt đơn hàng
                </h2>
                <ul
                  id="order-summary-list"
                  class="my-6 divide-y max-h-80 overflow-y-auto"
                ></ul>
                <div class="mt-6 space-y-2 border-t pt-4">
                  <div class="flex justify-between text-sm text-gray-600">
                    <p>Tạm tính</p>
                    <p id="summary-subtotal">0 ₫</p>
                  </div>
                  <div class="flex justify-between text-sm text-gray-600">
                    <p>Phí vận chuyển</p>
                    <p id="summary-shipping">30.000 ₫</p>
                  </div>
                  <div
                    class="flex justify-between text-base font-medium text-gray-900 pt-2 border-t mt-2"
                  >
                    <p>Tổng cộng</p>
                    <p id="summary-total" class="text-xl">0 ₫</p>
                  </div>
                </div>
                <div class="mt-6">
                  <button
                    type="submit"
                    id="btn-place-order"
                    class="w-full bg-gray-900 text-white py-3 px-4 rounded-md uppercase font-semibold hover:bg-gray-800 transition"
                  >
                    Đặt hàng
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div
      id="qr-modal"
      class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden"
      >
        <div
          class="bg-gradient-to-r from-gray-900 to-gray-700 text-white p-6 text-center"
        >
          <h3 class="text-2xl font-marcellus">Chuyển khoản thanh toán</h3>
        </div>
        <div class="p-6 space-y-5">
          <div class="text-center space-y-3">
            <p class="text-lg font-semibold">Số tiền chuyển khoản:</p>
            <p id="qr-amount" class="text-3xl font-bold text-red-600"></p>
            <p class="text-sm text-gray-600">Nội dung chuyển khoản:</p>
            <p
              id="qr-content"
              class="font-mono text-lg bg-gray-100 px-4 py-2 rounded"
            ></p>
            <div class="text-sm space-y-1">
              <p>Ngân hàng: <strong>Techcombank</strong></p>
              <p>Số tài khoản: <strong>19038861761019</strong></p>
              <p>Chủ tài khoản: <strong>KairaStore</strong></p>
            </div>
          </div>
          <div
            id="qr-container"
            class="flex justify-center bg-gray-50 p-6 rounded-lg"
          >
            <div class="text-gray-500">Đang tải QR...</div>
          </div>
          <p class="text-xs text-center text-gray-500">
            Mở app ngân hàng (Techcombank, MBBank, BIDV...) → Quét mã QR để
            chuyển tiền nhanh
          </p>
          <div class="flex gap-3">
            <button
              id="confirm-payment-btn"
              class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition"
            >
              Đã chuyển tiền
            </button>
            <button
              id="pay-later-btn"
              class="flex-1 bg-gray-600 text-white py-3 rounded-lg font-semibold hover:bg-gray-700 transition"
            >
              Thanh toán sau
            </button>
          </div>
        </div>
      </div>
    </div>

    <%- include('../partials/user/Footer') %> <%-
    include('../partials/user/Script') %>

    <script>
      $(document).ready(function () {
        const CART_KEY = "kaira_cart";
        const SHIPPING_FEE = 30000;

        const BANK_ID = "970407";
        const ACCOUNT_NO = "19038861761019";
        const ACCOUNT_NAME = "KairaStore";

        const formatCurrency = (amount) =>
          new Intl.NumberFormat("vi-VN", {
            style: "currency",
            currency: "VND",
          }).format(amount);

        function generateVietQRUrl(amount, content) {
          const cleanContent = content.replace(/[^a-zA-Z0-9 ]/g, "").trim();
          return `https://img.vietqr.io/image/${BANK_ID}-${ACCOUNT_NO}-compact.png?amount=${amount}&addInfo=${encodeURIComponent(cleanContent)}&accountName=${encodeURIComponent(ACCOUNT_NAME)}`;
        }

        function getCart() {
          const cart = localStorage.getItem(CART_KEY);
          return cart ? JSON.parse(cart) : [];
        }

        function getProductPrice(product, variantId, variantColor, size) {
          if (
            !product.has_variants ||
            !product.variants ||
            product.variants.length === 0
          ) {
            return product.price || 0;
          }
          if (variantId) {
            const variant = product.variants.find(
              (v) => String(v._id) === String(variantId)
            );
            if (variant && variant.sizes && variant.sizes.length > 0) {
              if (size) {
                const sizeObj = variant.sizes.find((s) => s.size === size);
                if (sizeObj && sizeObj.price) return sizeObj.price;
              }
              return variant.sizes[0].price;
            }
          }
          let minPrice = Infinity;
          product.variants.forEach((variant) => {
            if (variant.sizes)
              variant.sizes.forEach((s) => {
                if (s.price < minPrice) minPrice = s.price;
              });
          });
          return minPrice === Infinity ? 0 : minPrice;
        }

        function getProductImage(product, variantId, variantColor) {
          if (variantId && product.has_variants) {
            const variant = product.variants.find(
              (v) => String(v._id) === String(variantId)
            );
            if (variant && variant.images?.length > 0) return variant.images[0];
          }
          return (
            product.thumbnail ||
            product.images?.[0] ||
            "/images/default-product.jpg"
          );
        }

        function loadCartForCheckout() {
          const cartItems = getCart();
          if (!cartItems || cartItems.length === 0) {
            $("#empty-cart-view").removeClass("hidden");
            $("#checkout-view").addClass("hidden");
            return;
          }
          const idList = cartItems.map((item) => item.productId);
          $.ajax({
            url: "/products/by-ids",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ productIds: idList }),
            success: function (response) {
              if (response.success)
                renderOrderSummary(cartItems, response.products);
            },
          });
        }

        function renderOrderSummary(cartItems, productsData) {
          $("#empty-cart-view").addClass("hidden");
          $("#checkout-view").removeClass("hidden");
          const $list = $("#order-summary-list");
          $list.empty();
          let subtotal = 0;
          cartItems.forEach((cartItem) => {
            const product = productsData.find(
              (p) => String(p._id) === String(cartItem.productId)
            );
            if (!product) return;
            const price = getProductPrice(
              product,
              cartItem.variantId,
              cartItem.variantColor,
              cartItem.size
            );
            const imgUrl = getProductImage(
              product,
              cartItem.variantId,
              cartItem.variantColor
            );
            let variantText = "";
            if (product.has_variants) {
              const parts = [];
              if (cartItem.variantColor)
                parts.push(`Màu: ${cartItem.variantColor}`);
              if (cartItem.size) parts.push(`Size: ${cartItem.size}`);
              if (parts.length > 0)
                variantText = `<p class="text-xs text-gray-500 mt-1">${parts.join(
                  " | "
                )}</p>`;
            }
            const itemTotal = price * cartItem.quantity;
            subtotal += itemTotal;
            const html = `
              <li class="flex py-4 border-b last:border-0">
                <img src="${imgUrl}" class="h-20 w-20 rounded-md border object-cover" onerror="this.src='/images/default-product.jpg'">
                <div class="ml-4 flex-1">
                  <h4 class="text-sm font-medium"><a href="/product-detail?id=${
                    product._id
                  }" class="hover:text-gray-600">${product.name}</a></h4>
                  ${variantText}
                  <p class="text-sm text-gray-600 mt-1">${formatCurrency(
                    price
                  )} × ${cartItem.quantity}</p>
                </div>
                <div class="text-right"><p class="font-semibold">${formatCurrency(
                  itemTotal
                )}</p></div>
              </li>`;
            $list.append(html);
          });
          const total = subtotal + SHIPPING_FEE;
          $("#summary-subtotal").text(formatCurrency(subtotal));
          $("#summary-total").text(formatCurrency(total));
        }

        $("#checkoutForm").on("submit", function (e) {
          e.preventDefault();
          const cartItems = getCart();
          if (cartItems.length === 0) return alert("Giỏ hàng trống!");

          const email = $("#email").val().trim();
          const full_name = $("#full_name").val().trim();
          const phone = $("#phone").val().trim();
          const address = $("#address").val().trim();
          if (!email || !full_name || !phone || !address)
            return alert("Vui lòng điền đầy đủ thông tin!");

          if (!/^\S+@\S+\.\S+$/.test(email))
            return alert("Email không hợp lệ!");
          if (!/^[0-9]{10,11}$/.test(phone.replace(/\s/g, "")))
            return alert("Số điện thoại không hợp lệ!");

          const paymentMethod =
            $('input[name="payment_method"]:checked').val() || "cod";

          const orderData = {
            customer_info: {
              email,
              full_name,
              phone,
              address,
              note: $("#note").val().trim() || null,
            },
            payment_method: paymentMethod,
            items: cartItems.map((item) => ({
              productId: item.productId,
              variantId: item.variantId || null,
              variantColor: item.variantColor || null,
              size: item.size || null,
              quantity: Number(item.quantity),
            })),
          };

          $("#loading-overlay").css("display", "flex");
          $("#btn-place-order").prop("disabled", true).text("Đang xử lý...");

          $.ajax({
            url: "/checkout/create-order",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(orderData),
            success: function (response) {
              if (response.success) {
                localStorage.removeItem(CART_KEY);
                if (typeof window.updateCartCount === "function")
                  window.updateCartCount();

                if (
                  paymentMethod === "bank_transfer" &&
                  response.payment_method === "bank_transfer"
                ) {
                  const order = response.order;
                  const content = `DH ${order.order_number}`;
                  const qrUrl = generateVietQRUrl(order.total, content);

                  $("#qr-amount").text(formatCurrency(order.total));
                  $("#qr-content").text(content);
                  $("#qr-container").html(
                    `<img src="${qrUrl}" class="w-64 h-64 object-contain" alt="QR VietQR">`
                  );

                  const successUrl = `/order-success/${order._id}`;
                  $("#confirm-payment-btn, #pay-later-btn")
                    .off("click")
                    .on("click", () => {
                      window.location.href = successUrl;
                    });

                  $("#qr-modal").removeClass("hidden").addClass("flex");
                  $("#loading-overlay").hide();
                } else {
                  window.location.href = `/order-success/${response.order._id}`;
                }
              } else {
                alert(response.message || "Có lỗi xảy ra");
                $("#loading-overlay").hide();
                $("#btn-place-order").prop("disabled", false).text("Đặt hàng");
              }
            },
            error: function () {
              alert("Lỗi kết nối server");
              $("#loading-overlay").hide();
              $("#btn-place-order").prop("disabled", false).text("Đặt hàng");
            },
          });
        });

        loadCartForCheckout();
      });
    </script>
  </body>
</html>
